services:

  # --- SERVICE PLATFORM ---
  platform:
    build:
      context: ./services/platform
      dockerfile: Dockerfile
    container_name: lnm3_platform
    restart: unless-stopped
    environment:
      DATABASE_URL: ecto://user:pass@db-platform:5432/lnm3_platform
      SECRET_KEY_BASE: ${SECRET_KEY_BASE:-CHANGE_ME_IN_PRODUCTION_GENERATE_WITH_mix_phx_gen_secret_MINIMUM_64_CHARS}
      PHX_HOST: ${PHX_HOST:-localhost}
      PHX_SERVER: "true"
      PORT: 4000
      CORS_ORIGINS: ${CORS_ORIGINS:-http://localhost:8000,http://localhost:3000}
    ports:
      - "4000:4000"
    depends_on:
      db-platform:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:4000/ || exit 1"]
      interval: 30s
      timeout: 3s
      start_period: 40s
      retries: 3

  db-platform:
     image: postgres:18-alpine
     container_name: lnm3_platform_db
     environment:
       POSTGRES_USER: user
       POSTGRES_PASSWORD: pass
       POSTGRES_DB: lnm3_platform
     ports:
       - "5432:5432"
     volumes:
       - db_data:/var/lib/postgresql/data
     healthcheck:
       test: [ "CMD-SHELL", "pg_isready -U user -d lnm3_platform" ]
       interval: 5s
       timeout: 5s
       retries: 5

   adminer:
     image: adminer
     container_name: lnm3_platform_adminer
     restart: always
     ports:
       - "8081:8080"
     environment:
       ADMINER_DEFAULT_SERVER: db-platform
     depends_on:
       - db-platform

  # --- FRONTEND ---
  # frontend:
  #   build:
  #     context: ./frontend
  #     dockerfile: Dockerfile
  #   container_name: svelte-frontend
  #   environment:
  #     - PUBLIC_API_URL=http://localhost:4000
  #   ports:
  #     - "5173:5173"
  #   depends_on:
  #     - platform

volumes:
  db_data:
